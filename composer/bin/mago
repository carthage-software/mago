#!/usr/bin/env php
<?php

declare(strict_types=1);

namespace Mago\Internal;

use Composer;
use RuntimeException;

use function array_shift;
use function class_exists;
use function fwrite;

use const STDERR;

(function (): never {
    // Ensure autoloader is loaded (Composer bin proxy loads it, but handle direct execution too)
    if (!class_exists(Composer\InstalledVersions::class, false)) {
        $loaded = false;
        foreach ([__DIR__ . '/../../../../autoload.php', __DIR__ . '/../../vendor/autoload.php'] as $file) {
            if (file_exists($file)) {
                require $file;
                $loaded = true;
                break;
            }
        }

        if (!$loaded) {
            fwrite(STDERR, "Error: Composer autoloader not found. Run 'composer install' first.\n");
            exit(1);
        }
    }

    try {
        $version = namespace\get_version();
        $architecture = namespace\detect_architecture();
        $platform = namespace\detect_platform($architecture);
        $triple = namespace\build_target_triple(
            $architecture,
            $platform['vendor'],
            $platform['os'],
            $platform['suffix'],
        );

        $extension = namespace\get_archive_extension($platform['os'], $platform['suffix']);
        $executable = namespace\ensure_binary($version, $triple, $platform['extension'], $extension, __DIR__);

        $args = $_SERVER['argv'];
        array_shift($args);

        namespace\execute($executable, $args);
    } catch (RuntimeException $e) {
        fwrite(STDERR, "Error: {$e->getMessage()}\n");
        exit(1);
    }
})();
